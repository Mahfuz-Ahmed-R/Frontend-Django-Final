<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Wishlist - Fabrilife.com</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <link rel="stylesheet" href="styleWish.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="wishlist-container">
            <h2 class="text-center mb-4">My Wishlist</h2>

            <div id="wishlist-items">
              <!-- Wishlist items will be dynamically loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Fetch wishlist items
      fetch("http://127.0.0.1:8000/wishlist/")
        .then((response) => response.json())
        .then((data) => {
          wishlistShow(data);
          console.log("Success:", data);
        })
        .catch((error) => {
          console.error("Error:", error);
        });

      // Function to display wishlist items
      const wishlistShow = (products) => {
        const main_div = document.getElementById("wishlist-items");
        products.forEach((product) => {
          const div = document.createElement("div");
          div.classList.add("wishlist-item");
          div.innerHTML = `
                <img src="${product.product_image}" alt="${product.product_name}" class="item-image">
                <div class="item-details">
                    <h3 class="item-name">${product.product_name}</h3>
                    <p class="item-price">Price: ${product.product_price} | Size: ${product.size_name} | Quantity: ${product.quantity}</p>
                </div>
                <button class="btn btn-add-to-cart me-2" onclick="add_product(${product.product}, '${product.size}', ${product.quantity}, ${product.id},this)">Add to Cart</button>
                <button class="btn btn-remove" onclick="handleDelete(${product.id}, this)">Remove</button>
            `;
          main_div.appendChild(div);
        });
      };

      function add_product(p_id, p_size, p_quantity, id, element) {
        let customer_id;
        const user_id = localStorage.getItem("user_id");

        fetch(`http://127.0.0.1:8000/customer/${user_id}/`)
          .then((response) => response.json())
          .then((data) => {
            customer_id = data.id;

            const orderData = {
              product: p_id,
              customer: customer_id,
              size: p_size,
              quantity: p_quantity,
            };

            fetch("http://127.0.0.1:8000/order-item/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderData),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log("Success:", data);
                alert("Product added to cart successfully");
                handleDelete(id, element); 
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          })
          .catch((error) => {
            console.error("Error fetching customer:", error);
          });
      }

      function handleDelete(id, element) {
        fetch(`http://127.0.0.1:8000/wishlist/${id}/`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              // Remove the item from the DOM
              element.closest(".wishlist-item").remove();
              console.log(`Item with id ${id} deleted`);
            } else {
              console.error("Failed to delete item");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
    <script src="scripts.js"></script>
  </body>
</html>
